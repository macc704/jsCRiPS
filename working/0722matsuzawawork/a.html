<html>

<head>
    <script src="esprima-2.4.1/esprima.js"></script>
    <script src="escodegen-1.6.1/escodegen.browser.js"></script>
    <script type="text/javascript">
    function convert() {
        var source = document.getElementById('source').value;
        var ast = esprima.parse(source);
        var yield = esprima.parse('th.join();').body[0];

        //for debug       
        document.getElementById('ast').value = JSON.stringify(ast, null, 4);

        var processStatement = function(stmt) {
            if (stmt.type === 'BlockStatement') {
                stmt.body = processStatements(stmt.body);
            }
            if (stmt.type === 'ExpressionStatement' && stmt.expression.type === 'CallExpression') {
                console.log('here');
                var block = esprima.parse('{}').body[0];
                block.body.push(stmt);
                block.body.push(yield);
                return block;
            }
            return stmt;
        };

        var processStatements = function(stmts) {
            var newStmts = [];
            stmts.forEach(function(each) {
                if (each.type === 'IfStatement') {
                    each.consequent = processStatement(each.consequent);
                    each.alternate = processStatement(each.alternate);
                }
                if (each.body) { //while series
                    each.body = processStatement(each.body);
                };
                newStmts.push(each);
                if (each.type === 'ExpressionStatement' && each.expression.type === 'CallExpression') {
                    newStmts.push(yield);
                }
            });
            return newStmts;
        };

        var newBody = processStatements(ast.body);
        ast.body = newBody;
        var translated = escodegen.generate(ast);
        document.getElementById('result').value = translated;
    }
    </script>
</head>

<body>
    <h1>Test2</h1>
    <textarea id="source" cols="45" rows="20">
        fd(100);
    </textarea>
    <button type="button" onclick="convert()">press me</button>
    </br>
    <textarea id="result" cols="45" rows="20">
    </textarea>
    <textarea id="ast" cols="45" rows="20">
    </textarea>
</body>

</html>